/////////////
/* INCLUDES:*/
#include <LiquidCrystal.h>
#include <Wire.h> // Library for I2C communication
//#include <LiquidCrystal_I2C.h> // Library for LCD
// Wiring: SDA pin is connected to A4 and SCL pin to A5.
// Connect to LCD via I2C, default address 0x27 (A0-A2 not jumpered)
// LiquidCrystal_I2C.h: https://github.com/johnrickman/LiquidCrystal_I2C
// 


///////////////
/* VARIABLES:*/

// Variables pour le LCD Display:
LiquidCrystal lcd(12,11,5,4,3,2);

// Variables pour le modules: 
int trig = 8;// yellow wire
int echo = 9;// green wire
long lecture_echo;
long mesure = 0;
long m3 = 0;

//Variables pour module voltmetre:
int value = 0;
float R1 = 12352.0;
float R2 = 17647.0;
float voltage = 0;

//Variables LoRA:
HardwareSerial SerialLora(D0, D1);


///////////////////////////////
/* PROTOTYPES & DECLARATIONS: */
// Affiche les informations matriels. 
void infoHardware(){
   lcd.begin(20,4);
   lcd.setCursor(0,0);
   lcd.print ("Water tank level");
   lcd.setCursor(0,1);
   lcd.print ("Firmware v1.3");
   lcd.setCursor(0,2);
   lcd.print ("Hardware: prototype");
   lcd.setCursor(0,3);
   lcd.print ("Adrien DEWULF");
  delay (2000);
  lcd.clear();
}

// Mesure et affiche
void printResultat(){
  digitalWrite(trig, HIGH);
  delayMicroseconds(10);
  digitalWrite(trig, LOW);
  lecture_echo = pulseIn(echo,HIGH);
  mesure = (((lecture_echo /58)-53)/18.2);
  m3 = (10-mesure); 
  Serial.print("Volume en metre cube");
  Serial.println(m3);
  lcd.setCursor (0,0);
  lcd.print ("Volume en metre cube");
  lcd.setCursor (2,1);
  lcd.print (m3);
  lcd.setCursor (7,1);
  lcd.print ("M3");
  delay(500);
  lcd.clear();
}
// Mesure volt
void mesureVolt(){
  value = analogRead(A0);
  voltage = (value * (5.0/1024)*((R1 + R2)/R2))-0.1;
}


//LiquidCrystal_I2C lcd = LiquidCrystal_I2C(0x27, 16, 2); // Change to (0x27,16,2) for 16x2 LCD.
////////////
/* SETUP: */

void setup(){

     pinMode(trig, OUTPUT);
     digitalWrite(trig, LOW);

     pinMode(echo, INPUT);
     Serial.begin(9600);
     Serial.println ("Adrien Dewulf");

     // Initiate the LCD:
     //lcd.init();        //I2C 
     //lcd.backlight();   //I2C
     lcd.begin(16,2);

     // Port sÃ©rie pour le LoRA:
       Serial.begin(115200);
       SerialLora.begin(115200);
     
     
     
}


///////////
/* LOOP: */

   void loop() {
//  infoHardware();
  mesureVolt();
//  printResultat();

  // Print 'Hello World!' on the first line of the LCD:
  lcd.setCursor(0, 0); // Set the cursor on the first column and first row.
  lcd.print("Vol:"); // Print the string "Vol: pour indiquer le volume de la citerne."
  lcd.setCursor(
  lcd.setCursor(0, 1); //Set the cursor on the third column and the second row (counting starts at 0!).
  lcd.print("Tension: ");
  lcd.setCursor(9, 1); // 
  lcd.print(voltage);
  lcd.setCursor(14,1);
  lcd.print("V");


  Serial.print("U= "); Serial.print(voltage);  Serial.print("V");
  delay(500);
  
  
// The loop function runs over and over again forever
  char c;
  if (SerialLora.available() > 0)
  {
    c = SerialLora.read();
    Serial.print(c);
  }
  if (Serial.available() > 0)
  {
    c = Serial.read();
    SerialLora.print(c);
  }
  
}
